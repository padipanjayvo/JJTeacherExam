<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Prevent text selection and context menu */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- การตั้งค่า (Configuration) ---
        
        // 1. นำ URL ของ Web App ที่ได้จากการ Deploy มาใส่ที่นี่ (เพื่อให้บันทึกคะแนนได้)
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxiyyDb159TUXP3jARuL1jCcRuLC5BlgODRGUVCXHlxpdT3qF6F5BFy7NpMUY2mf0BZhg/exec"; 
        
        // 2. ใส่ Gemini API Key ที่นี่ (ถ้าต้องการใช้ฟีเจอร์ AI)
        const GEMINI_API_KEY = ""; 

        // --- ไอคอน SVG Components (แทน Lucide React) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const Loader2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Volume2 = (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>} />;
        const Sparkles = (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></>} />;
        const PauseCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="10" y1="15" x2="10" y2="9"/><line x1="14" y1="15" x2="14" y2="9"/></>} />;

        // --- ข้อมูลข้อสอบ ---
        const EXAM_DATA = [
            // --- ส่วนที่ 1: ภาษา C (printf, scanf) และ Flowchart (40 ข้อ) ---
            { id: 1, question: "คำสั่งใดใช้สำหรับแสดงผลข้อมูลทางหน้าจอในภาษา C", options: ["scanf()", "printf()", "read()", "input()"], answer: 1 },
            { id: 2, question: "สัญลักษณ์ %d ในคำสั่ง printf ใช้สำหรับข้อมูลชนิดใด", options: ["จำนวนทศนิยม", "ตัวอักษร", "จำนวนเต็ม", "ข้อความ"], answer: 2 },
            { id: 3, question: "หากต้องการรับค่าตัวเลขจำนวนเต็มจากคีย์บอร์ด ต้องใช้คำสั่งใด", options: ["scanf(\"%d\", &x);", "printf(\"%d\", x);", "get(\"%d\", &x);", "input(\"%d\", x);"], answer: 0 },
            { id: 4, question: "ข้อใดคือรูปแบบโครงสร้างพื้นฐานของฟังก์ชัน printf", options: ["printf(format, variable);", "print(variable);", "show(text);", "display(format);"], answer: 0 },
            { id: 5, question: "สัญลักษณ์ & หน้าตัวแปรในคำสั่ง scanf มีหน้าที่อะไร", options: ["ระบุค่าคงที่", "ระบุตำแหน่งหน่วยความจำ (Address)", "ทำให้ตัวแปรเป็นตัวหนา", "ไม่มีความหมาย"], answer: 1 },
            { id: 6, question: "รหัสควบคุม (Escape Sequence) \\n หมายถึงอะไร", options: ["เว้นวรรค", "ขึ้นบรรทัดใหม่", "เสียงเตือน", "แท็บแนวนอน"], answer: 1 },
            { id: 7, question: "ใน Flowchart สัญลักษณ์รูปสี่เหลี่ยมผืนผ้า (Rectangle) หมายถึงอะไร", options: ["การรับค่า", "การตัดสินใจ", "การประมวลผล (Process)", "จุดเริ่มต้น"], answer: 2 },
            { id: 8, question: "ใน Flowchart สัญลักษณ์รูปสี่เหลี่ยมขนมเปียกปูน (Diamond) หมายถึงอะไร", options: ["การแสดงผล", "การตัดสินใจ (Decision)", "จุดสิ้นสุด", "การเชื่อมต่อ"], answer: 1 },
            { id: 9, question: "ใน Flowchart สัญลักษณ์รูปวงรี (Oval / Terminal) ใช้สำหรับอะไร", options: ["เริ่มต้นและสิ้นสุด", "การคำนวณ", "การรับข้อมูล", "การวนซ้ำ"], answer: 0 },
            { id: 10, question: "คำสั่ง scanf(\"%f\", &price); ใช้รับค่าข้อมูลประเภทใด", options: ["จำนวนเต็ม", "ตัวอักษร", "จำนวนทศนิยม", "ข้อความยาว"], answer: 2 },
            { id: 11, question: "ข้อใดเขียนคำสั่ง printf ได้ถูกต้อง", options: ["printf 'Hello';", "printf(\"Hello World\");", "cout >> \"Hello\";", "System.out.print(\"Hello\");"], answer: 1 },
            { id: 12, question: "ผลลัพธ์ของ printf(\"5 + 5 = %d\", 5+5); คือข้อใด", options: ["5 + 5 = %d", "10", "5 + 5 = 10", "Error"], answer: 2 },
            { id: 13, question: "สัญลักษณ์ทิศทาง (Arrow) ใน Flowchart ใช้ทำอะไร", options: ["บอกทิศทางการทำงาน", "ตกแต่งให้สวยงาม", "ใส่คอมเมนต์", "ลบข้อมูล"], answer: 0 },
            { id: 14, question: "หากต้องการแสดงผลเครื่องหมาย % ต้องเขียนอย่างไรใน printf", options: ["%", "%%", "\\%", "&%"], answer: 1 },
            { id: 15, question: "Library มาตรฐานที่ต้องเรียกใช้เพื่อใช้ printf และ scanf คืออะไร", options: ["<math.h>", "<conio.h>", "<stdio.h>", "<stdlib.h>"], answer: 2 },
            { id: 16, question: "ข้อใดไม่ใช่ชนิดข้อมูลพื้นฐานในภาษา C", options: ["int", "float", "char", "string (แบบ primitive)"], answer: 3 },
            { id: 17, question: "สัญลักษณ์ %c ใช้กับข้อมูลชนิดใด", options: ["Character (ตัวอักษรเดียว)", "Integer", "Float", "Double"], answer: 0 },
            { id: 18, question: "การรับค่า String ในภาษา C ด้วย scanf ใช้รหัสรูปแบบใด", options: ["%d", "%c", "%s", "%f"], answer: 2 },
            { id: 19, question: "ใน Flowchart สัญลักษณ์สี่เหลี่ยมด้านขนาน (Parallelogram) คืออะไร", options: ["ประมวลผล", "รับข้อมูล/แสดงผล", "ตัดสินใจ", "จุดเชื่อมต่อ"], answer: 1 },
            { id: 20, question: "คำสั่ง #include <stdio.h> มักวางไว้ส่วนใดของโปรแกรม", options: ["ส่วนท้ายสุด", "ในฟังก์ชัน main", "ส่วนหัวของโปรแกรม", "ตรงไหนก็ได้"], answer: 2 },
            { id: 21, question: "ข้อใดคือผลลัพธ์ของ printf(\"AB\\tC\");", options: ["ABC", "AB   C (มีช่องว่าง)", "AB\\tC", "ขึ้นบรรทัดใหม่"], answer: 1 },
            { id: 22, question: "ถ้า int a = 10; printf(\"%d\", a); จะแสดงผลอะไร", options: ["a", "10", "%d", "Error"], answer: 1 },
            { id: 23, question: "เครื่องหมาย ; (Semicolon) ในภาษา C มีความสำคัญอย่างไร", options: ["ใช้จบคำสั่ง", "ใช้เริ่มฟังก์ชัน", "ใช้คอมเมนต์", "ไม่จำเป็นต้องใส่"], answer: 0 },
            { id: 24, question: "Flowchart ที่ดีควรมีจุดเริ่มต้นและจุดสิ้นสุดกี่จุด", options: ["เริ่มต้น 1 สิ้นสุด 1", "เริ่มต้นหลายจุด", "ไม่มีจุดสิ้นสุด", "สิ้นสุดกี่จุดก็ได้แต่เริ่มต้น 1"], answer: 0 },
            { id: 25, question: "การเขียน Flowchart ช่วยประโยชน์ในด้านใดมากที่สุด", options: ["ทำให้คอมพิวเตอร์ทำงานเร็วขึ้น", "ช่วยลำดับความคิดและขั้นตอนการทำงาน", "ประหยัดหน่วยความจำ", "ไม่ต้องเขียนโค้ดจริง"], answer: 1 },
            { id: 26, question: "ข้อใดเป็นชื่อตัวแปรที่ **ผิด** กฎภาษา C", options: ["number1", "_score", "2student", "data_value"], answer: 2 },
            { id: 27, question: "ฟังก์ชันหลักที่โปรแกรมภาษา C ต้องมีเสมอคือ", options: ["start()", "main()", "begin()", "program()"], answer: 1 },
            { id: 28, question: "scanf(\"%d %d\", &a, &b); หมายความว่าอย่างไร", options: ["รับค่าจำนวนเต็ม 1 ค่า", "รับค่าจำนวนเต็ม 2 ค่าต่อเนื่อง", "แสดงผลค่า a และ b", "รับค่าทศนิยม"], answer: 1 },
            { id: 29, question: "สัญลักษณ์วงกลมเล็กๆ ใน Flowchart (Connector) ใช้เมื่อใด", options: ["เริ่มต้นโปรแกรม", "เชื่อมต่อผังงานในหน้าเดียวกัน", "แสดงผลลัพธ์", "ตัดสินใจ"], answer: 1 },
            { id: 30, question: "หากลืมใส่ & ในคำสั่ง scanf จะเกิดอะไรขึ้น", options: ["โปรแกรมทำงานปกติ", "เกิด Error หรือโปรแกรมหยุดทำงาน", "ค่าจะถูกรีเซ็ตเป็น 0", "คอมพิวเตอร์รีสตาร์ท"], answer: 1 },
            { id: 31, question: "ข้อใดคือความหมายของ Algorithm", options: ["ภาษาโปรแกรม", "ขั้นตอนวิธีการแก้ปัญหา", "ฮาร์ดแวร์คอมพิวเตอร์", "ระบบปฏิบัติการ"], answer: 1 },
            { id: 32, question: "รหัส %2d ใน printf หมายถึงอะไร", options: ["แสดงทศนิยม 2 ตำแหน่ง", "แสดงเลขจำนวนเต็มจองพื้นที่ 2 ช่อง", "แสดงเลข 2 ตัว", "แสดงเลขฐานสอง"], answer: 1 },
            { id: 33, question: "รหัส %.2f ใน printf หมายถึงอะไร", options: ["แสดงทศนิยม 2 ตำแหน่ง", "จองพื้นที่ 2 ช่อง", "แสดงเลขจำนวนเต็ม", "แสดงเป็นเปอร์เซ็นต์"], answer: 0 },
            { id: 34, question: "ถ้า a=5, b=2; printf(\"%d\", a/b); จะได้ผลลัพธ์เท่าใด (Integer Division)", options: ["2.5", "2", "3", "Error"], answer: 1 },
            { id: 35, question: "การเขียนคอมเมนต์บรรทัดเดียวในภาษา C ใช้สัญลักษณ์ใด", options: ["//", "/* */", "#", "--"], answer: 0 },
            { id: 36, question: "โครงสร้างแบบลำดับ (Sequence) ใน Flowchart คืออะไร", options: ["ทำซ้ำไปเรื่อยๆ", "ทำจากบนลงล่างตามลูกศร", "มีการเลือกเส้นทาง", "กระโดดข้ามขั้นตอน"], answer: 1 },
            { id: 37, question: "ข้อมูลประเภท double ต่างจาก float อย่างไร", options: ["เก็บข้อมูลได้น้อยกว่า", "เก็บทศนิยมได้ละเอียดและมากกว่า", "เก็บตัวอักษร", "ไม่ต่างกัน"], answer: 1 },
            { id: 38, question: "คำสั่ง return 0; ใน main() บอกอะไรกับระบบ", options: ["โปรแกรมทำงานผิดพลาด", "โปรแกรมทำงานเสร็จสมบูรณ์", "เริ่มทำงานใหม่", "หยุดชั่วคราว"], answer: 1 },
            { id: 39, question: "ตัวดำเนินการทางคณิตศาสตร์ใดที่ใช้หาเศษเหลือ", options: ["/", "*", "%", "^"], answer: 2 },
            { id: 40, question: "การเขียน Flowchart ก่อนเขียนโค้ดเรียกว่าขั้นตอนใด", options: ["Coding", "Testing", "Design", "Maintenance"], answer: 2 },
            // --- ส่วนที่ 2: HTML เบื้องต้น ฉบับเด็กปฐมศึกษา (20 ข้อ) ---
            { id: 41, question: "HTML ย่อมาจากอะไร", options: ["Hyper Text Markup Language", "High Tech Main Language", "Home Tool Made Language", "Hyper Tool Make Link"], answer: 0 },
            { id: 42, question: "คำสั่งใดใช้สร้างตัวอักษร **หนา**", options: ["<i>", "<b>", "<u>", "<p>"], answer: 1 },
            { id: 43, question: "ถ้าอยากขีดเส้นใต้ข้อความ ต้องใช้คำสั่งใด", options: ["<u>", "<s>", "<line>", "<ul>"], answer: 0 },
            { id: 44, question: "คำสั่งใดใช้สำหรับขึ้นบรรทัดใหม่", options: ["<lb>", "<br>", "<new>", "<next>"], answer: 1 },
            { id: 45, question: "โครงสร้างหลักของ HTML ต้องเริ่มต้นด้วยคำสั่งใด", options: ["<body>", "<head>", "<html>", "<start>"], answer: 2 },
            { id: 46, question: "ส่วนหัวของเว็บเพจที่ใช้เก็บชื่อเรื่อง (Title) อยู่ในส่วนใด", options: ["<footer>", "<body>", "<head>", "<leg>"], answer: 2 },
            { id: 47, question: "เนื้อหา รูปภาพ และข้อความต่างๆ บนหน้าเว็บต้องใส่ในส่วนใด", options: ["<head>", "<title>", "<body>", "<end>"], answer: 2 },
            { id: 48, question: "คำสั่งใดใช้สร้างหัวข้อที่ตัวใหญ่ที่สุด", options: ["<h6>", "<h3>", "<h1>", "<head>"], answer: 2 },
            { id: 49, question: "คำสั่งใดใช้สำหรับใส่รูปภาพ", options: ["<image>", "<img>", "<pic>", "<photo>"], answer: 1 },
            { id: 50, question: "ถ้าอยากทำตัวอักษร *เอียง* ต้องใช้คำสั่งอะไร", options: ["<b>", "<u>", "<i>", "<e>"], answer: 2 },
            { id: 51, question: "เครื่องหมายใดใช้ปิดคำสั่ง (Close Tag) เช่น ปิด body", options: ["\\", "/", "*", "#"], answer: 1 },
            { id: 52, question: "คำสั่ง <p> ย่อมาจากอะไร", options: ["Page", "Picture", "Paragraph (ย่อหน้า)", "Print"], answer: 2 },
            { id: 53, question: "คำสั่งใดใช้สร้างลิ้งค์ (Link) ไปยังหน้าอื่น", options: ["<a>", "<link>", "<go>", "<href>"], answer: 0 },
            { id: 54, question: "ภาษา HTML ใช้สร้างอะไร", options: ["โปรแกรมคำนวณ", "เว็บไซต์", "เกม 3 มิติ", "หุ่นยนต์"], answer: 1 },
            { id: 55, question: "ถ้าจะเปลี่ยนสีตัวอักษรต้องใช้ Attribute ใด (แบบเก่าหรือ CSS)", options: ["color", "paint", "text", "draw"], answer: 0 },
            { id: 56, question: "คำสั่ง <center> ใช้ทำอะไร", options: ["จัดกึ่งกลาง", "จัดชิดซ้าย", "จัดชิดขวา", "ทำตัวหนา"], answer: 0 },
            { id: 57, question: "นามสกุลของไฟล์เว็บเพจคืออะไร", options: [".docx", ".ppt", ".html", ".mp3"], answer: 2 },
            { id: 58, question: "โปรแกรมใดใช้เปิดดูผลลัพธ์ของไฟล์ HTML", options: ["Web Browser (เช่น Chrome)", "Microsoft Word", "Paint", "Calculator"], answer: 0 },
            { id: 59, question: "รายการแบบมีจุดลำดับ (Bullet) ใช้คำสั่งใด", options: ["<ol>", "<ul>", "<li>", "<dl>"], answer: 1 },
            { id: 60, question: "ข้อใดคือรูปแบบการปิด Tag ที่ถูกต้อง", options: ["<body/>", "</body>", "<end body>", "</close>"], answer: 1 },
        ];

        // --- Helper Functions ---
        function pcmToWav(pcmData, sampleRate) {
            const headerLength = 44;
            const dataLength = pcmData.length;
            const buffer = new ArrayBuffer(headerLength + dataLength);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);

            const pcmBytes = new Uint8Array(pcmData);
            const wavBytes = new Uint8Array(buffer, 44);
            wavBytes.set(pcmBytes);

            return buffer;
        }

        // --- Main Component ---
        const { useState, useEffect, useRef } = React;

        function ExamSystem() {
            const [step, setStep] = useState('login');
            const [studentInfo, setStudentInfo] = useState({ name: '', number: '' });
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(90 * 60);
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [score, setScore] = useState(0);
            const [securityWarning, setSecurityWarning] = useState("");
            const [saveStatus, setSaveStatus] = useState('idle');
            
            // AI States
            const [aiFeedback, setAiFeedback] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [isAudioLoading, setIsAudioLoading] = useState(false);
            const [playingQuestionId, setPlayingQuestionId] = useState(null);
            
            const audioRef = useRef(null);
            const examRef = useRef(null);

            // --- Security Logic ---
            useEffect(() => {
                const handleContextMenu = (e) => {
                    e.preventDefault();
                    setSecurityWarning("ไม่อนุญาตให้คลิกขวา!");
                    setTimeout(() => setSecurityWarning(""), 2000);
                };

                const handleKeyDown = (e) => {
                    if (
                        e.key === 'PrintScreen' ||
                        e.keyCode === 44 || 
                        e.keyCode === 123 || 
                        (e.ctrlKey && e.key === 'u') || 
                        (e.ctrlKey && e.key === 'c') || 
                        (e.ctrlKey && e.key === 'v')    
                    ) {
                        e.preventDefault();
                        setSecurityWarning("ตรวจพบการกระทำต้องห้าม: กรุณาทำข้อสอบอย่างซื่อสัตย์");
                        setTimeout(() => setSecurityWarning(""), 3000);
                        
                        if (examRef.current) {
                            examRef.current.style.filter = "blur(10px)";
                            setTimeout(() => { if(examRef.current) examRef.current.style.filter = "none"; }, 3000);
                        }
                    }
                };

                const handleCopy = (e) => {
                    e.preventDefault();
                    setSecurityWarning("ไม่อนุญาตให้คัดลอก!");
                    setTimeout(() => setSecurityWarning(""), 2000);
                }

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('copy', handleCopy);
                document.addEventListener('cut', handleCopy);
                document.addEventListener('paste', handleCopy);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('keydown', handleKeyDown);
                    document.removeEventListener('copy', handleCopy);
                    document.removeEventListener('cut', handleCopy);
                    document.removeEventListener('paste', handleCopy);
                };
            }, []);

            // --- Timer Logic ---
            useEffect(() => {
                if (step === 'exam' && timeLeft > 0 && !isSubmitted) {
                    const timerId = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                    return () => clearInterval(timerId);
                } else if (timeLeft === 0 && step === 'exam') {
                    handleSubmit();
                }
            }, [step, timeLeft, isSubmitted]);

            // --- AI Functions ---
            const handleSpeakQuestion = async (text, qId) => {
                if (!GEMINI_API_KEY) {
                    alert("กรุณาใส่ API Key ในโค้ดก่อนใช้งานฟีเจอร์นี้");
                    return;
                }

                if (playingQuestionId === qId) {
                    if (audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current = null;
                    }
                    setPlayingQuestionId(null);
                    return;
                }

                setIsAudioLoading(true);
                setPlayingQuestionId(qId);

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            }
                        })
                    });

                    if (!response.ok) throw new Error('TTS API Error');

                    const result = await response.json();
                    const inlineData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    
                    if (inlineData) {
                        const sampleRate = 24000;
                        const pcmData = Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0));
                        const wavBuffer = pcmToWav(pcmData, sampleRate);
                        const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        
                        if (audioRef.current) audioRef.current.pause();
                        const audio = new Audio(url);
                        audioRef.current = audio;
                        audio.play();
                        audio.onended = () => setPlayingQuestionId(null);
                    }
                } catch (error) {
                    console.error("TTS Error", error);
                    alert("ขออภัย ไม่สามารถอ่านเสียงได้ในขณะนี้");
                    setPlayingQuestionId(null);
                } finally {
                    setIsAudioLoading(false);
                }
            };

            const handleGenerateFeedback = async () => {
                if (!GEMINI_API_KEY) {
                    setAiFeedback("กรุณาใส่ API Key ในโค้ดเพื่อใช้งานฟีเจอร์นี้");
                    return;
                }
                
                setIsAiLoading(true);
                let wrongTopics = [];
                let wrongCount = 0;
                
                EXAM_DATA.forEach(q => {
                    if (answers[q.id] !== q.answer) {
                        wrongCount++;
                        if (q.id <= 40) wrongTopics.push(`C/Flowchart (ข้อ ${q.id})`);
                        else wrongTopics.push(`HTML (ข้อ ${q.id})`);
                    }
                });

                const topicSummary = wrongTopics.length > 0 ? wrongTopics.join(", ") : "ไม่มี (ทำถูกหมด)";

                const prompt = `
                    Act as a kind, encouraging Thai teacher. 
                    Student Name: ${studentInfo.name}.
                    Score: ${score}/60.
                    The student got these questions wrong: ${topicSummary}.
                    Question IDs 1-40 are C Programming/Flowchart. IDs 41-60 are Basic HTML.
                    Please provide a short (3-5 sentences), warm, and constructive feedback in Thai language.
                    If the score is low, encourage them to study specific topics based on their wrong answers.
                    If the score is high, congratulate them.
                    Use emojis.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setAiFeedback(text || "ไม่สามารถวิเคราะห์ผลได้ในขณะนี้");
                } catch (error) {
                    setAiFeedback("เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI Coach");
                } finally {
                    setIsAiLoading(false);
                }
            };

            // --- Handlers ---
            const handleStartExam = () => {
                if (studentInfo.name.trim() && studentInfo.number.trim()) {
                    setStep('exam');
                    try {
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch((e) => {});
                        }
                    } catch(e) {}
                } else {
                    alert("กรุณากรอกชื่อและเลขที่ให้ครบถ้วน");
                }
            };

            const handleAnswerChange = (questionId, optionIndex) => {
                setAnswers({ ...answers, [questionId]: optionIndex });
            };

            const handleSubmit = () => {
                let tempScore = 0;
                EXAM_DATA.forEach((q) => {
                    if (answers[q.id] === q.answer) {
                        tempScore += 1;
                    }
                });
                setScore(tempScore);
                setIsSubmitted(true);
                setStep('result');
                saveScoreToSheet(tempScore);
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(() => {});
                }
            };

            const saveScoreToSheet = async (finalScore) => {
                if (!WEB_APP_URL) {
                    console.log("No Web App URL provided");
                    return;
                }

                setSaveStatus('saving');
                try {
                    // ใช้ fetch แบบ no-cors ไปยัง Web App URL ตัวเอง
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: studentInfo.name,
                            number: studentInfo.number,
                            score: finalScore,
                            timestamp: new Date().toLocaleString('th-TH')
                        })
                    });
                    setSaveStatus('success');
                } catch (error) {
                    console.error("Save Error:", error);
                    setSaveStatus('error');
                }
            };

            const formatTime = (seconds) => {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hours > 0) return `${hours}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // --- Render Logic (Login) ---
            if (step === 'login') {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 select-none" onContextMenu={(e)=>e.preventDefault()}>
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-blue-600">
                            <div className="text-center mb-6">
                                <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Lock className="w-8 h-8 text-blue-600" />
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800">ระบบสอบออนไลน์</h1>
                                <p className="text-gray-500 mt-2">คุณครูปฎิภาณ พานทอง</p>
                                <p className="text-gray-500 mt-2">การเขียนโปรแกรมเชิงวัตถุเบื้องต้น
รหัสวิชา 21910_201</p>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล นักเรียน</label>
                                    <input
                                        type="text"
                                        value={studentInfo.name}
                                        onChange={(e) => setStudentInfo({ ...studentInfo, name: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="ด.ช. รักเรียน เขียนโค้ด"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">เลขที่</label>
                                    <input
                                        type="text"
                                        value={studentInfo.number}
                                        onChange={(e) => setStudentInfo({ ...studentInfo, number: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="เช่น 15"
                                    />
                                </div>

                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800 flex items-start gap-2">
                                    <AlertTriangle className="w-5 h-5 flex-shrink-0" />
                                    <div>
                                        <strong>ข้อตกลงการสอบ:</strong>
                                        <ul className="list-disc pl-4 mt-1 space-y-1">
                                            <li>เวลาสอบ: 1 ชั่วโมง 30 นาที</li>
                                            <li>ห้ามแค๊ปหน้าจอ หรือถ่ายรูป</li>
                                            <li>ห้ามคลิกขวา หรือคัดลอกข้อความ</li>
                                        </ul>
                                    </div>
                                </div>

                                <button
                                    onClick={handleStartExam}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors shadow-lg"
                                >
                                    เริ่มทำข้อสอบ
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- Render Logic (Result) ---
            if (step === 'result') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
                            <div className={`${score >= 30 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6`}>
                                {score >= 30 ? <CheckCircle className="w-10 h-10" /> : <XCircle className="w-10 h-10" />}
                            </div>
                            <h2 className="text-3xl font-bold text-gray-800 mb-2">ผลการสอบ</h2>
                            <p className="text-xl text-gray-600 mb-6">
                                คุณ {studentInfo.name} (เลขที่ {studentInfo.number})
                            </p>

                            <div className="bg-gray-100 p-6 rounded-xl mb-6">
                                <div className="text-gray-500 mb-1">คะแนนที่ได้</div>
                                <div className="text-5xl font-extrabold text-blue-600">{score} / 60</div>
                                <div className="text-sm text-gray-400 mt-2">
                                    {(score / 60) * 100 >= 50 ? "ผ่านเกณฑ์มาตรฐาน" : "ควรทบทวนเนื้อหาเพิ่มเติม"}
                                </div>
                            </div>

                             {/* AI Feedback Section */}
                            <div className="mb-6 border-t pt-4">
                                {!aiFeedback ? (
                                    <button 
                                        onClick={handleGenerateFeedback}
                                        disabled={isAiLoading}
                                        className="w-full flex items-center justify-center gap-2 bg-purple-100 text-purple-700 hover:bg-purple-200 py-3 rounded-xl transition-all font-bold"
                                    >
                                        {isAiLoading ? <Loader2 className="animate-spin w-5 h-5"/> : <Sparkles className="w-5 h-5"/>}
                                        {isAiLoading ? "กำลังวิเคราะห์ข้อมูล..." : "วิเคราะห์ผลการสอบด้วย AI (AI Coach)"}
                                    </button>
                                ) : (
                                    <div className="bg-purple-50 p-4 rounded-xl text-left border border-purple-100">
                                        <h4 className="flex items-center gap-2 font-bold text-purple-800 mb-2">
                                            <Sparkles className="w-4 h-4"/> คำแนะนำจาก AI Coach
                                        </h4>
                                        <p className="text-gray-700 text-sm leading-relaxed whitespace-pre-line">
                                            {aiFeedback}
                                        </p>
                                    </div>
                                )}
                            </div>

                            {/* Save Status Display */}
                            {WEB_APP_URL ? (
                                <div className="mb-6">
                                    {saveStatus === 'saving' && (
                                        <div className="flex items-center justify-center text-blue-600 gap-2">
                                            <Loader2 className="w-5 h-5 animate-spin" />
                                            <span>กำลังบันทึกคะแนนลงระบบ...</span>
                                        </div>
                                    )}
                                    {saveStatus === 'success' && (
                                        <div className="flex items-center justify-center text-green-600 gap-2">
                                            <CheckCircle className="w-5 h-5" />
                                            <span>บันทึกคะแนนเรียบร้อยแล้ว</span>
                                        </div>
                                    )}
                                    {saveStatus === 'error' && (
                                        <div className="flex items-center justify-center text-red-600 gap-2">
                                            <XCircle className="w-5 h-5" />
                                            <span>บันทึกคะแนนไม่สำเร็จ โปรดแจ้งครูผู้สอน</span>
                                        </div>
                                    )}
                                </div>
                            ) : null}

                            <button
                                onClick={() => window.location.reload()}
                                className="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors"
                            >
                                ออกจากระบบ
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render Logic (Exam) ---
            return (
                <div 
                    ref={examRef}
                    className="min-h-screen bg-gray-50 flex flex-col select-none relative" 
                    onContextMenu={(e) => e.preventDefault()}
                    style={{ WebkitUserSelect: 'none', MozUserSelect: 'none', msUserSelect: 'none', userSelect: 'none' }}
                >
                    {/* Security Warning Overlay */}
                    {securityWarning && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80">
                            <div className="bg-white p-6 rounded-lg shadow-2xl flex flex-col items-center animate-pulse">
                                <AlertTriangle className="w-12 h-12 text-red-600 mb-2" />
                                <h3 className="text-xl font-bold text-red-600">{securityWarning}</h3>
                            </div>
                        </div>
                    )}

                    {/* Header Bar */}
                    <header className="bg-white shadow-md sticky top-0 z-10 px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <User className="w-5 h-5 text-blue-600" />
                            <div>
                                <div className="font-bold text-gray-800">{studentInfo.name}</div>
                                <div className="text-xs text-gray-500">เลขที่ {studentInfo.number}</div>
                            </div>
                        </div>

                        <div className={`flex items-center gap-2 px-4 py-2 rounded-full font-mono text-lg font-bold ${timeLeft < 300 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-blue-100 text-blue-700'}`}>
                            <Clock className="w-5 h-5" />
                            {formatTime(timeLeft)}
                        </div>
                    </header>

                    {/* Question List */}
                    <main className="flex-1 max-w-4xl mx-auto w-full p-4 md:p-6 space-y-6">
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r">
                            <h3 className="font-bold text-blue-800">คำชี้แจง</h3>
                            <p className="text-sm text-blue-700">ข้อสอบมีทั้งหมด 60 ข้อ (ภาษา C 40 ข้อ, HTML 20 ข้อ) | เวลา 1 ชั่วโมง 30 นาที</p>
                        </div>

                        {EXAM_DATA.map((q, index) => (
                            <div key={q.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                <div className="flex gap-3 mb-4 items-start">
                                    <span className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold mr-2">
                                        {index + 1}
                                    </span>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <h3 className="text-lg font-medium text-gray-800 mt-0.5">{q.question}</h3>
                                            <button 
                                                onClick={() => handleSpeakQuestion(q.question, q.id)}
                                                disabled={isAudioLoading && playingQuestionId !== q.id}
                                                className={`p-2 rounded-full transition-colors ${playingQuestionId === q.id ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600'}`}
                                                title="อ่านโจทย์ให้ฟัง (AI)"
                                            >
                                                {isAudioLoading && playingQuestionId === q.id ? <Loader2 className="w-4 h-4 animate-spin"/> : (
                                                    playingQuestionId === q.id ? <PauseCircle className="w-4 h-4"/> : <Volume2 className="w-4 h-4"/>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 pl-0 md:pl-11">
                                    {q.options.map((opt, optIndex) => (
                                        <label 
                                            key={optIndex} 
                                            className={`
                                                relative flex items-center p-3 rounded-lg border-2 cursor-pointer transition-all
                                                ${answers[q.id] === optIndex 
                                                ? 'border-blue-500 bg-blue-50' 
                                                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                                }
                                            `}
                                        >
                                            <input
                                                type="radio"
                                                name={`q-${q.id}`}
                                                value={optIndex}
                                                checked={answers[q.id] === optIndex}
                                                onChange={() => handleAnswerChange(q.id, optIndex)}
                                                className="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                                            />
                                            <span className="ml-3 text-gray-700">{opt}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        ))}

                        <div className="pt-6 pb-12 text-center">
                            <div className="mb-4 text-gray-500 text-sm">
                                ทำไปแล้ว {Object.keys(answers).length} จาก {EXAM_DATA.length} ข้อ
                            </div>
                            <button
                                onClick={() => {
                                    if(window.confirm("ยืนยันการส่งข้อสอบ? เมื่อส่งแล้วจะไม่สามารถแก้ไขได้")) {
                                        handleSubmit();
                                    }
                                }}
                                className="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all"
                            >
                                ส่งข้อสอบ
                            </button>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExamSystem />);
    </script>
</body>
</html>
